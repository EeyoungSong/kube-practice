name: Build and Push to ACR

on:
  push:
    branches:
      - main
    paths:
      - "app.py"
      - "requirements.txt"
      - "Dockerfile"
      - ".github/workflows/build.yml"

env:
  REGISTRY: eeyoungacr.azurecr.io # ✅ ACR 이름으로 바꿔주세요
  IMAGE_NAME: kube-practice-api # ✅ 원하는 이미지 이름
  INFRA_REPO: song-eeyoung/kube-practice-infra # ✅ Infra Repo 주소 (user/repo 형식)

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout app repo
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to ACR
        run: az acr login --name ${{ env.REGISTRY }}

      - name: Build and push Docker image
        run: |
          IMAGE_TAG=${{ github.sha }}
          echo "Building image: $REGISTRY/$IMAGE_NAME:$IMAGE_TAG"
          docker build -t $REGISTRY/$IMAGE_NAME:$IMAGE_TAG .
          docker push $REGISTRY/$IMAGE_NAME:$IMAGE_TAG
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      # ✅ 다음 단계: Infra Repo의 deployment.yaml 이미지 태그 업데이트
      - name: Checkout Infra Repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.INFRA_REPO }}
          path: infra
          token: ${{ secrets.GH_TOKEN }}

      - name: Update image tag in Infra Repo
        run: |
          DEPLOYMENT_FILE="infra/k8s/deployment.yaml"
          IMAGE_TAG=${{ env.IMAGE_TAG }}
          echo "Updating image tag in $DEPLOYMENT_FILE"
          sed -i "s#image: .*\$#image: $REGISTRY/$IMAGE_NAME:$IMAGE_TAG#g" $DEPLOYMENT_FILE

      - name: Commit and push Infra Repo changes
        run: |
          cd infra
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Update image tag to $IMAGE_TAG"
          git push
